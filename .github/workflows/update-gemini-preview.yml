name: Update Gemini CLI Preview Version

on:
  schedule:
    - cron: '30 * * * *'  # Run every hour, offset by 30 mins
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  check-and-update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Nix
        uses: cachix/install-nix-action@v24
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes
            access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}

      - name: Update version
        id: update
        run: |
          ./scripts/update-preview-version.sh
          
          if git diff --quiet package-preview.nix; then
            echo "update_needed=false" >> $GITHUB_OUTPUT
          else
            echo "update_needed=true" >> $GITHUB_OUTPUT
            LATEST_VERSION=$(grep 'version =' package-preview.nix | cut -d '"' -f 2)
            echo "latest=$LATEST_VERSION" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.update.outputs.update_needed == 'true'
        id: create-pr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update gemini-cli-preview to version ${{ steps.update.outputs.latest }}"
          title: "chore: update gemini-cli-preview to version ${{ steps.update.outputs.latest }}"
          body: |
            ## Automated Gemini CLI Preview Update
            
            This PR updates Gemini CLI Preview to version `${{ steps.update.outputs.latest }}`.
            
            ### Changes
            - Updated `version` in `package-preview.nix`
            - Updated `sha256` hash
            
            This PR was automatically generated by the update workflow.
          branch: update-gemini-cli-preview-${{ steps.update.outputs.latest }}
          delete-branch: true
          labels: |
            dependencies
            automated
            preview

      - name: Enable Auto-Merge
        if: steps.update.outputs.update_needed == 'true' && steps.create-pr.outputs.pull-request-number
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr merge ${{ steps.create-pr.outputs.pull-request-number }} --auto --squash --delete-branch
